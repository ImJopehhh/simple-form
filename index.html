<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Login/Register</title>
</head>
<body>
  <h2>Login / Register</h2>
  <form id="form">
    <input type="email" id="email" placeholder="Email" required />
    <input type="password" id="password" placeholder="Password" required />
    <select id="mode">
      <option value="login">Login</option>
      <option value="register">Register</option>
    </select>
    <select id="role" style="display:none">
      <option value="member">Member</option>
      <option value="admin">Admin</option>
    </select>
    <button type="submit">Lanjut</button>
  </form>

  <script type="module">
    import { auth, db } from './firebase.js';
    import {
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      doc, setDoc, getDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const form = document.getElementById("form");
    const roleSelect = document.getElementById("role");
    const mode = document.getElementById("mode");

    mode.addEventListener("change", () => {
      roleSelect.style.display = mode.value === "register" ? "block" : "none";
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = form.email.value;
      const password = form.password.value;
      const modeVal = mode.value;
      const role = roleSelect.value;

      try {
        if (modeVal === "register") {
          const userCred = await createUserWithEmailAndPassword(auth, email, password);
          await setDoc(doc(db, "users", userCred.user.uid), {
            email, role
          });
          alert("Registrasi berhasil. Login otomatis.");
          location.href = "dashboard.html";
        } else {
          const userCred = await signInWithEmailAndPassword(auth, email, password);
          const userDoc = await getDoc(doc(db, "users", userCred.user.uid));
          if (!userDoc.exists()) throw new Error("Akun tidak memiliki role.");
          location.href = "dashboard.html";
        }
      } catch (err) {
        alert("Error: " + err.message);
      }
    });
  </script>
</body>
  </html>
